---
import Layout from '../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';

// Get all class notes, sorted by date (newest first)
const allClasses = await getCollection('classes');
const sortedClasses = allClasses.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});

// Render all classes
const renderedClasses = await Promise.all(
  sortedClasses.map(async (classNote) => {
    const { Content } = await render(classNote);
    return { ...classNote, Content };
  })
);
---

<Layout title="BJJ Classes">
  <div class="page">
    <div class="container">
      <header class="header">
        <img src="/bjj/logo.svg" alt="BJJ Classes - Franco Andrade" class="logo" />
        <a href="/bjj/feedback" class="feedback-button">Give feedback</a>
      </header>
      
      <div class="posts">
        {renderedClasses.map(({ data, Content }) => (
          <article class="post">
            <main class="main-content">
              <header class="post-header">
                <time class="post-date">{data.date}</time>
                <h2 class="post-title">{data.title}</h2>
              </header>

              {data.references && data.references.length > 0 && (
                <details class="references-accordion">
                  <summary class="accordion-trigger">
                    <span class="accordion-label">Reference videos</span>
                    <svg class="chevron" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </summary>
                  <nav class="references">
                    {data.references.map((ref) => (
                      <a href={ref.url} target="_blank" rel="noopener noreferrer" class="external-link">
                        <span class="link-text">{ref.title}</span>
                      </a>
                    ))}
                  </nav>
                </details>
              )}
              
              <div class="post-content">
                <Content />
              </div>
            </main>

            <aside class="left-sidebar">
              <a 
                href={`https://www.youtube.com/shorts/${data.youtubeId}`} 
                target="_blank" 
                rel="noopener noreferrer" 
                class="thumbnail-container"
                data-youtube-id={data.youtubeId}
              >
                <img 
                  src={`https://img.youtube.com/vi/${data.youtubeId}/maxresdefault.jpg`}
                  alt={data.title}
                  class="thumbnail"
                  loading="lazy"
                />
                <div class="play-overlay">
                  <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="24" cy="24" r="24" fill="rgba(0,0,0,0.6)" />
                    <path d="M19 15L33 24L19 33V15Z" fill="white" />
                  </svg>
                </div>
              </a>
            </aside>
          </article>
        ))}
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div class="video-modal" id="videoModal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <button class="modal-close" aria-label="Close modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="video-container">
        <iframe 
          id="videoIframe"
          src="" 
          title="YouTube video player" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
          allowfullscreen
        ></iframe>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Only enable modal on desktop (screen width > 768px)
  const isDesktop = () => window.innerWidth > 768;
  
  const modal = document.getElementById('videoModal');
  const iframe = document.getElementById('videoIframe') as HTMLIFrameElement;
  const backdrop = modal?.querySelector('.modal-backdrop');
  const closeBtn = modal?.querySelector('.modal-close');
  
  // Handle thumbnail clicks
  document.querySelectorAll('.thumbnail-container[data-youtube-id]').forEach(link => {
    link.addEventListener('click', (e) => {
      if (!isDesktop()) return; // Let mobile users open in new tab
      
      e.preventDefault();
      const youtubeId = (link as HTMLElement).dataset.youtubeId;
      if (youtubeId && iframe && modal) {
        iframe.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;
        modal.classList.add('active');
      }
    });
  });
  
  // Close modal functions
  const closeModal = () => {
    if (modal && iframe) {
      modal.classList.remove('active');
      iframe.src = '';
    }
  };
  
  backdrop?.addEventListener('click', closeModal);
  closeBtn?.addEventListener('click', closeModal);
  
  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('active')) {
      closeModal();
    }
  });
</script>

<style>
  .page {
    min-height: 100vh;
    padding: 80px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  .page::before {
    content: '';
    position: fixed;
    top: 0;
    right: -20%;
    width: 70%;
    height: 100%;
    background-image: url('/bjj/francobw.jpg');
    background-size: cover;
    background-position: top left;
    background-repeat: no-repeat;
    pointer-events: none;
    z-index: -1;
    opacity: 0.08;
  }

  .container {
    width: 100%;
    max-width: 920px;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 88px;
  }

  .logo {
    width: 191px;
    height: auto;
  }

  .feedback-button {
    background-color: #ededed;
    padding: 16px 24px;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 16px;
    color: var(--grey-200);
    text-decoration: none;
    transition: opacity 0.2s ease;
    line-height: normal;
  }

  .feedback-button:hover {
    opacity: 0.6;
  }

  .posts {
    display: flex;
    flex-direction: column;
    gap: 80px;
    justify-content: flex-start;
    align-items: flex-start;
  }

  .post {
    display: flex;
    flex-wrap: wrap;
    gap: 56px;
    align-items: flex-start;
    width: 100%;
  }

  .left-sidebar {
    flex: 1 1 0;
    min-width: 200px;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 128px;
    height: 100%;
    justify-content: flex-start;
    align-items: flex-start;
  }

  .thumbnail-container {
    display: block;
    position: relative;
    width: 100%;
    max-width: 180px;
    aspect-ratio: 9 / 16;
    border-radius: 4px;
    overflow: hidden;
  }

  .thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .play-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .thumbnail-container:hover .play-overlay {
    opacity: 1;
  }

  .references-accordion {
    font-family: var(--font-mono);
    font-size: 12px;
  }

  .accordion-trigger {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    color: var(--grey-100);
    list-style: none;
  }

  .accordion-trigger::-webkit-details-marker {
    display: none;
  }

  .accordion-label {
    text-decoration: none;
  }

  .chevron {
    color: var(--grey-50);
    transition: transform 0.2s ease;
  }

  .references-accordion[open] .chevron {
    transform: rotate(180deg);
  }

  .references {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 12px;
  }

  .external-link {
    display: block;
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--grey-100);
    text-decoration: underline;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .external-link:hover {
    opacity: 0.8;
  }

  .main-content {
    flex: 1 1 0;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .post-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .post-date {
    font-family: var(--font-mono);
    font-size: 14px;
    color: var(--grey-100);
  }

  .post-title {
    font-family: var(--font-serif);
    font-size: 18px;
    font-weight: 400;
    color: var(--grey-300);
    margin: 0;
  }

  .post-content {
    font-family: var(--font-mono);
    font-size: 16px;
    color: var(--grey-300);
    opacity: 0.72;
    line-height: 26px;
  }

  .post-content :global(ul) {
    list-style-type: disc;
    margin-left: 24px;
    margin-bottom: 8px;
  }

  .post-content :global(ol) {
    list-style-type: lower-alpha;
    margin-left: 48px;
  }

  .post-content :global(li) {
    margin-bottom: 0;
  }

  .post-content :global(h2) {
    font-family: var(--font-mono);
    font-size: 16px;
    font-weight: 400;
    margin-top: 16px;
    margin-bottom: 8px;
  }

  .post-content :global(p) {
    margin-bottom: 8px;
  }

  /* Video Modal */
  .video-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .video-modal.active {
    opacity: 1;
    visibility: visible;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background-color: rgba(67, 67, 67, 0.7); /* grey-200 with 70% opacity */
  }

  .modal-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-height: 90vh;
    max-width: 90vw;
  }

  .modal-close {
    position: absolute;
    top: -40px;
    right: 0;
    background: none;
    border: none;
    color: var(--white);
    cursor: pointer;
    padding: 8px;
    transition: opacity 0.2s ease;
  }

  .modal-close:hover {
    opacity: 0.7;
  }

  .video-container {
    width: 360px;
    max-width: 90vw;
    aspect-ratio: 9 / 16;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
  }

  .video-container iframe {
    width: 100%;
    height: 100%;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .page::before {
      display: none;
    }

    .page {
      padding-top: 48px;
      padding-bottom: 48px;
    }

    .header {
      margin-bottom: 48px;
    }

    .logo {
      width: 143px;
    }

    .feedback-button {
      padding: 12px;
      font-size: 12px;
    }

    .post {
      gap: 48px;
    }

    .left-sidebar {
      margin-top: 0;
    }
  }
</style>
